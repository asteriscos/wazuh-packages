"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SaveDocument = void 0;

var _getConfiguration = require("../../lib/get-configuration");

var _logger = require("../../lib/logger");

var _indexDate = require("../../lib/index-date");

var _constants = require("../../../common/constants");

var _tryCatchForIndexPermissionError = require("../tryCatchForIndexPermissionError");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class SaveDocument {
  constructor(context) {
    _defineProperty(this, "context", void 0);

    _defineProperty(this, "esClientInternalUser", void 0);

    _defineProperty(this, "logPath", 'cron-scheduler|SaveDocument');

    this.context = context;
    this.esClientInternalUser = context.core.opensearch.client.asInternalUser;
  }

  async save(doc, indexConfig) {
    const {
      name,
      creation,
      mapping,
      shards,
      replicas
    } = indexConfig;
    const index = this.addIndexPrefix(name);
    const indexCreation = `${index}-${(0, _indexDate.indexDate)(creation)}`;

    try {
      await this.checkIndexAndCreateIfNotExists(indexCreation, shards, replicas);
      const createDocumentObject = this.createDocument(doc, indexCreation, mapping);
      const response = await this.esClientInternalUser.bulk(createDocumentObject);
      (0, _logger.log)(this.logPath, `Response of create new document ${JSON.stringify(response)}`, 'debug'); // await this.checkIndexPatternAndCreateIfNotExists(index);
    } catch (error) {
      if (error.status === 403) throw {
        error: 403,
        message: `Authorization Exception in the index "${index}"`
      };
      if (error.status === 409) throw {
        error: 409,
        message: `Duplicate index-pattern: ${index}`
      };
      throw error;
    }
  }

  async checkIndexAndCreateIfNotExists(index, shards, replicas) {
    try {
      await (0, _tryCatchForIndexPermissionError.tryCatchForIndexPermissionError)(index)(async () => {
        const exists = await this.esClientInternalUser.indices.exists({
          index
        });
        (0, _logger.log)(this.logPath, `Index '${index}' exists? ${exists.body}`, 'debug');

        if (!exists.body) {
          const response = await this.esClientInternalUser.indices.create({
            index,
            body: {
              settings: {
                index: {
                  number_of_shards: shards !== null && shards !== void 0 ? shards : _constants.WAZUH_STATISTICS_DEFAULT_INDICES_SHARDS,
                  number_of_replicas: replicas !== null && replicas !== void 0 ? replicas : _constants.WAZUH_STATISTICS_DEFAULT_INDICES_REPLICAS
                }
              }
            }
          });
          (0, _logger.log)(this.logPath, `Status of create a new index: ${JSON.stringify(response)}`, 'debug');
        }
      })();
    } catch (error) {
      this.checkDuplicateIndexError(error);
    }
  }

  checkDuplicateIndexError(error) {
    const {
      type
    } = ((error || {}).body || {}).error || {};
    if (!['resource_already_exists_exception'].includes(type)) throw error;
  }

  createDocument(doc, index, mapping) {
    const createDocumentObject = {
      index,
      body: doc.map(item => `{"index": { "_index": "${index}" }}\n${JSON.stringify({ ...this.buildData(item, mapping),
        timestamp: new Date(Date.now()).toISOString()
      })}\n`).join('')
    };
    (0, _logger.log)(this.logPath, `Document object: ${JSON.stringify(createDocumentObject)}`, 'debug');
    return createDocumentObject;
  }

  buildData(item, mapping) {
    const getItemArray = (array, index) => {
      return JSON.stringify(array[index || 0]);
    };

    const getValue = (key, item) => {
      const keys = key.split('.');

      if (keys.length === 1) {
        if (key.match(/\[.*\]/)) {
          return getItemArray(item[key.replace(/\[.*\]/, '')], key.match(/\[(.*)\]/)[1]);
        }

        return JSON.stringify(item[key]);
      }

      return getValue(keys.slice(1).join('.'), item[keys[0]]);
    };

    if (mapping) {
      let data;
      data = mapping.replace(/\${([a-z|A-Z|0-9|\.\-\_\[.*\]]+)}/gi, (...key) => getValue(key[1], item));
      return JSON.parse(data);
    }

    if (typeof item.data === 'object') {
      return item.data;
    }

    return {
      data: item.data
    };
  }

  addIndexPrefix(index) {
    const configFile = (0, _getConfiguration.getConfiguration)();
    const prefix = configFile['cron.prefix'] || 'wazuh';
    return `${prefix}-${index}`;
  }

}

exports.SaveDocument = SaveDocument;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNhdmUtZG9jdW1lbnQudHMiXSwibmFtZXMiOlsiU2F2ZURvY3VtZW50IiwiY29uc3RydWN0b3IiLCJjb250ZXh0IiwiZXNDbGllbnRJbnRlcm5hbFVzZXIiLCJjb3JlIiwib3BlbnNlYXJjaCIsImNsaWVudCIsImFzSW50ZXJuYWxVc2VyIiwic2F2ZSIsImRvYyIsImluZGV4Q29uZmlnIiwibmFtZSIsImNyZWF0aW9uIiwibWFwcGluZyIsInNoYXJkcyIsInJlcGxpY2FzIiwiaW5kZXgiLCJhZGRJbmRleFByZWZpeCIsImluZGV4Q3JlYXRpb24iLCJjaGVja0luZGV4QW5kQ3JlYXRlSWZOb3RFeGlzdHMiLCJjcmVhdGVEb2N1bWVudE9iamVjdCIsImNyZWF0ZURvY3VtZW50IiwicmVzcG9uc2UiLCJidWxrIiwibG9nUGF0aCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvciIsInN0YXR1cyIsIm1lc3NhZ2UiLCJleGlzdHMiLCJpbmRpY2VzIiwiYm9keSIsImNyZWF0ZSIsInNldHRpbmdzIiwibnVtYmVyX29mX3NoYXJkcyIsIldBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9JTkRJQ0VTX1NIQVJEUyIsIm51bWJlcl9vZl9yZXBsaWNhcyIsIldBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9JTkRJQ0VTX1JFUExJQ0FTIiwiY2hlY2tEdXBsaWNhdGVJbmRleEVycm9yIiwidHlwZSIsImluY2x1ZGVzIiwibWFwIiwiaXRlbSIsImJ1aWxkRGF0YSIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJ0b0lTT1N0cmluZyIsImpvaW4iLCJnZXRJdGVtQXJyYXkiLCJhcnJheSIsImdldFZhbHVlIiwia2V5Iiwia2V5cyIsInNwbGl0IiwibGVuZ3RoIiwibWF0Y2giLCJyZXBsYWNlIiwic2xpY2UiLCJkYXRhIiwicGFyc2UiLCJjb25maWdGaWxlIiwicHJlZml4Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFVTyxNQUFN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LFFBQUksT0FBT2pCLElBQUksQ0FBQ2lCLElBQVosS0FBcUIsUUFBekIsRUFBbUM7QUFDakMsYUFBT2pCLElBQUksQ0FBQ2lCLElBQVo7QUFDRDs7QUFDRCxXQUFPO0FBQUVBLE1BQUFBLElBQUksRUFBRWpCLElBQUksQ0FBQ2lCO0FBQWIsS0FBUDtBQUNEOztBQUVPM0MsRUFBQUEsY0FBYyxDQUFDRCxLQUFELEVBQWdCO0FBQ3BDLFVBQU04QyxVQUFVLEdBQUcseUNBQW5CO0FBQ0EsVUFBTUMsTUFBTSxHQUFHRCxVQUFVLENBQUMsYUFBRCxDQUFWLElBQTZCLE9BQTVDO0FBQ0EsV0FBUSxHQUFFQyxNQUFPLElBQUcvQyxLQUFNLEVBQTFCO0FBQ0Q7O0FBN0d1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJ1bGtJbmRleERvY3VtZW50c1BhcmFtcyB9IGZyb20gJ2VsYXN0aWNzZWFyY2gnO1xuaW1wb3J0IHsgZ2V0Q29uZmlndXJhdGlvbiB9IGZyb20gJy4uLy4uL2xpYi9nZXQtY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi8uLi9saWIvbG9nZ2VyJztcbmltcG9ydCB7IGluZGV4RGF0ZSB9IGZyb20gJy4uLy4uL2xpYi9pbmRleC1kYXRlJztcbmltcG9ydCB7IFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9JTkRJQ0VTX1NIQVJEUywgV0FaVUhfU1RBVElTVElDU19ERUZBVUxUX0lORElDRVNfUkVQTElDQVMgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vY29uc3RhbnRzJztcbmltcG9ydCB7IHRyeUNhdGNoRm9ySW5kZXhQZXJtaXNzaW9uRXJyb3IgfSBmcm9tICcuLi90cnlDYXRjaEZvckluZGV4UGVybWlzc2lvbkVycm9yJztcblxuZXhwb3J0IGludGVyZmFjZSBJSW5kZXhDb25maWd1cmF0aW9uIHtcbiAgbmFtZTogc3RyaW5nXG4gIGNyZWF0aW9uOiAnaCcgfCAnZCcgfCAndycgfCAnbSdcbiAgbWFwcGluZz86IHN0cmluZ1xuICBzaGFyZHM/OiBudW1iZXJcbiAgcmVwbGljYXM/OiBudW1iZXJcbn1cblxuZXhwb3J0IGNsYXNzIFNhdmVEb2N1bWVudCB7XG4gIGNvbnRleHQ6IGFueTtcbiAgZXNDbGllbnRJbnRlcm5hbFVzZXI6IGFueTtcbiAgbG9nUGF0aCA9ICdjcm9uLXNjaGVkdWxlcnxTYXZlRG9jdW1lbnQnO1xuXG4gIGNvbnN0cnVjdG9yKGNvbnRleHQpIHtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgIHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIgPSBjb250ZXh0LmNvcmUub3BlbnNlYXJjaC5jbGllbnQuYXNJbnRlcm5hbFVzZXI7XG4gIH1cblxuICBhc3luYyBzYXZlKGRvYzogb2JqZWN0W10sIGluZGV4Q29uZmlnOiBJSW5kZXhDb25maWd1cmF0aW9uKSB7XG4gICAgY29uc3QgeyBuYW1lLCBjcmVhdGlvbiwgbWFwcGluZywgc2hhcmRzLCByZXBsaWNhcyB9ID0gaW5kZXhDb25maWc7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmFkZEluZGV4UHJlZml4KG5hbWUpO1xuICAgIGNvbnN0IGluZGV4Q3JlYXRpb24gPSBgJHtpbmRleH0tJHtpbmRleERhdGUoY3JlYXRpb24pfWA7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuY2hlY2tJbmRleEFuZENyZWF0ZUlmTm90RXhpc3RzKGluZGV4Q3JlYXRpb24sIHNoYXJkcywgcmVwbGljYXMpO1xuICAgICAgY29uc3QgY3JlYXRlRG9jdW1lbnRPYmplY3QgPSB0aGlzLmNyZWF0ZURvY3VtZW50KGRvYywgaW5kZXhDcmVhdGlvbiwgbWFwcGluZyk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIuYnVsayhjcmVhdGVEb2N1bWVudE9iamVjdCk7XG4gICAgICBsb2codGhpcy5sb2dQYXRoLCBgUmVzcG9uc2Ugb2YgY3JlYXRlIG5ldyBkb2N1bWVudCAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gLCAnZGVidWcnKTtcbiAgICAgIC8vIGF3YWl0IHRoaXMuY2hlY2tJbmRleFBhdHRlcm5BbmRDcmVhdGVJZk5vdEV4aXN0cyhpbmRleCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvci5zdGF0dXMgPT09IDQwMylcbiAgICAgICAgdGhyb3cgeyBlcnJvcjogNDAzLCBtZXNzYWdlOiBgQXV0aG9yaXphdGlvbiBFeGNlcHRpb24gaW4gdGhlIGluZGV4IFwiJHtpbmRleH1cImAgfVxuICAgICAgaWYgKGVycm9yLnN0YXR1cyA9PT0gNDA5KVxuICAgICAgICB0aHJvdyB7IGVycm9yOiA0MDksIG1lc3NhZ2U6IGBEdXBsaWNhdGUgaW5kZXgtcGF0dGVybjogJHtpbmRleH1gIH1cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2hlY2tJbmRleEFuZENyZWF0ZUlmTm90RXhpc3RzKGluZGV4LCBzaGFyZHMsIHJlcGxpY2FzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRyeUNhdGNoRm9ySW5kZXhQZXJtaXNzaW9uRXJyb3IoaW5kZXgpIChhc3luYygpID0+IHtcbiAgICAgICAgY29uc3QgZXhpc3RzID0gYXdhaXQgdGhpcy5lc0NsaWVudEludGVybmFsVXNlci5pbmRpY2VzLmV4aXN0cyh7IGluZGV4IH0pO1xuICAgICAgICBsb2codGhpcy5sb2dQYXRoLCBgSW5kZXggJyR7aW5kZXh9JyBleGlzdHM/ICR7ZXhpc3RzLmJvZHl9YCwgJ2RlYnVnJyk7XG4gICAgICAgIGlmICghZXhpc3RzLmJvZHkpIHtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIuaW5kaWNlcy5jcmVhdGUoe1xuICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICBib2R5OiB7XG4gICAgICAgICAgICAgIHNldHRpbmdzOiB7XG4gICAgICAgICAgICAgICAgaW5kZXg6IHtcbiAgICAgICAgICAgICAgICAgIG51bWJlcl9vZl9zaGFyZHM6IHNoYXJkcyA/PyBXQVpVSF9TVEFUSVNUSUNTX0RFRkFVTFRfSU5ESUNFU19TSEFSRFMsXG4gICAgICAgICAgICAgICAgICBudW1iZXJfb2ZfcmVwbGljYXM6IHJlcGxpY2FzID8/IFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9JTkRJQ0VTX1JFUExJQ0FTXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgbG9nKHRoaXMubG9nUGF0aCwgYFN0YXR1cyBvZiBjcmVhdGUgYSBuZXcgaW5kZXg6ICR7SlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpfWAsICdkZWJ1ZycpO1xuICAgICAgICB9XG4gICAgICB9KSgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmNoZWNrRHVwbGljYXRlSW5kZXhFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0R1cGxpY2F0ZUluZGV4RXJyb3IoZXJyb3I6IGFueSkge1xuICAgIGNvbnN0IHsgdHlwZSB9ID0gKChlcnJvciB8fCB7fSkuYm9keSB8fCB7fSkuZXJyb3IgfHwge307XG4gICAgaWYgKCFbJ3Jlc291cmNlX2FscmVhZHlfZXhpc3RzX2V4Y2VwdGlvbiddLmluY2x1ZGVzKHR5cGUpKVxuICAgICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURvY3VtZW50KGRvYywgaW5kZXgsIG1hcHBpbmc6IHN0cmluZyk6IEJ1bGtJbmRleERvY3VtZW50c1BhcmFtcyB7XG4gICAgY29uc3QgY3JlYXRlRG9jdW1lbnRPYmplY3Q6IEJ1bGtJbmRleERvY3VtZW50c1BhcmFtcyA9IHtcbiAgICAgIGluZGV4LFxuICAgICAgYm9keTogZG9jLm1hcChpdGVtID0+IGB7XCJpbmRleFwiOiB7IFwiX2luZGV4XCI6IFwiJHtpbmRleH1cIiB9fVxcbiR7SlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAuLi50aGlzLmJ1aWxkRGF0YShpdGVtLCBtYXBwaW5nKSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpXG4gICAgICB9KX1cXG5gKVxuICAgICAgLmpvaW4oJycpXG4gICAgfTtcbiAgICBsb2codGhpcy5sb2dQYXRoLCBgRG9jdW1lbnQgb2JqZWN0OiAke0pTT04uc3RyaW5naWZ5KGNyZWF0ZURvY3VtZW50T2JqZWN0KX1gLCAnZGVidWcnKTtcbiAgICByZXR1cm4gY3JlYXRlRG9jdW1lbnRPYmplY3Q7XG4gIH1cblxuICBidWlsZERhdGEoaXRlbSwgbWFwcGluZykge1xuICAgIGNvbnN0IGdldEl0ZW1BcnJheSA9IChhcnJheSwgaW5kZXgpID0+IHtcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhcnJheVtpbmRleCB8fCAwXSk7XG4gICAgfTtcbiAgICBjb25zdCBnZXRWYWx1ZSA9IChrZXk6IHN0cmluZywgaXRlbSkgPT4ge1xuICAgICAgY29uc3Qga2V5cyA9IGtleS5zcGxpdCgnLicpO1xuICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGlmKGtleS5tYXRjaCgvXFxbLipcXF0vKSl7XG4gICAgICAgICAgcmV0dXJuIGdldEl0ZW1BcnJheShcbiAgICAgICAgICAgIGl0ZW1ba2V5LnJlcGxhY2UoL1xcWy4qXFxdLywgJycpXSxcbiAgICAgICAgICAgIGtleS5tYXRjaCgvXFxbKC4qKVxcXS8pWzFdXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoaXRlbVtrZXldKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBnZXRWYWx1ZShrZXlzLnNsaWNlKDEpLmpvaW4oJy4nKSwgaXRlbVtrZXlzWzBdXSlcbiAgICB9XG4gICAgaWYgKG1hcHBpbmcpIHtcbiAgICAgIGxldCBkYXRhO1xuICAgICAgZGF0YSA9IG1hcHBpbmcucmVwbGFjZShcbiAgICAgICAgL1xcJHsoW2EtenxBLVp8MC05fFxcLlxcLVxcX1xcWy4qXFxdXSspfS9naSxcbiAgICAgICAgKC4uLmtleSkgPT4gZ2V0VmFsdWUoa2V5WzFdLCBpdGVtKVxuICAgICAgKVxuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBpdGVtLmRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICByZXR1cm4gaXRlbS5kYXRhO1xuICAgIH1cbiAgICByZXR1cm4geyBkYXRhOiBpdGVtLmRhdGEgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkSW5kZXhQcmVmaXgoaW5kZXgpOiBzdHJpbmcge1xuICAgIGNvbnN0IGNvbmZpZ0ZpbGUgPSBnZXRDb25maWd1cmF0aW9uKCk7XG4gICAgY29uc3QgcHJlZml4ID0gY29uZmlnRmlsZVsnY3Jvbi5wcmVmaXgnXSB8fCAnd2F6dWgnO1xuICAgIHJldHVybiBgJHtwcmVmaXh9LSR7aW5kZXh9YDtcbiAgfVxuXG59XG4iXX0=