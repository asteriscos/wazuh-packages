"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.jobSchedulerRun = jobSchedulerRun;

var _index = require("./index");

var _configuredJobs = require("./configured-jobs");

var _logger = require("../../lib/logger");

var _getConfiguration = require("../../lib/get-configuration");

var _nodeCron = _interopRequireDefault(require("node-cron"));

var _constants = require("../../../common/constants");

var _statisticsTemplate = require("../../integration-files/statistics-template");

var _utils = require("../../../common/utils");

var _settings = require("../../../common/services/settings");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const blueWazuh = '\u001b[34mwazuh\u001b[39m';
const schedulerErrorLogColors = [blueWazuh, 'scheduler', 'error'];
const schedulerJobs = [];
/**
* Wait until Kibana server is ready
*/

const checkPluginPlatformStatus = async function (context) {
  try {
    (0, _logger.log)('scheduler-handler:checkPluginPlatformStatus', 'Waiting for Kibana and Elasticsearch servers to be ready...', 'debug');
    await checkElasticsearchServer(context);
    await checkTemplate(context);
    return;
  } catch (error) {
    (0, _logger.log)('scheduler-handler:checkPluginPlatformStatus', error.mesage || error);

    try {
      await (0, _utils.delayAsPromise)(3000);
      await checkPluginPlatformStatus(context);
    } catch (error) {}

    ;
  }
};
/**
 * Check Elasticsearch Server status and Kibana index presence
 */


const checkElasticsearchServer = async function (context) {
  try {
    const data = await context.core.opensearch.client.asInternalUser.indices.exists({
      index: context.server.config.opensearchDashboards.index
    });
    return data.body;
  } catch (error) {
    (0, _logger.log)('scheduler-handler:checkElasticsearchServer', error.message || error);
    return Promise.reject(error);
  }
};
/**
* Verify wazuh-statistics template
*/


const checkTemplate = async function (context) {
  try {
    (0, _logger.log)('scheduler-handler:checkTemplate', 'Updating the statistics template', 'debug');
    const appConfig = await (0, _getConfiguration.getConfiguration)();
    const prefixTemplateName = appConfig['cron.prefix'] || (0, _settings.getSettingDefaultValue)('cron.prefix');
    const statisticsIndicesTemplateName = appConfig['cron.statistics.index.name'] || (0, _settings.getSettingDefaultValue)('cron.statistics.index.name');
    const pattern = `${prefixTemplateName}-${statisticsIndicesTemplateName}-*`;

    try {
      // Check if the template already exists
      const currentTemplate = await context.core.opensearch.client.asInternalUser.indices.getTemplate({
        name: _constants.WAZUH_STATISTICS_TEMPLATE_NAME
      }); // Copy already created index patterns

      _statisticsTemplate.statisticsTemplate.index_patterns = currentTemplate.body[_constants.WAZUH_STATISTICS_TEMPLATE_NAME].index_patterns;
    } catch (error) {
      // Init with the default index pattern
      _statisticsTemplate.statisticsTemplate.index_patterns = [pattern];
    } // Check if the user is using a custom pattern and add it to the template if it does


    if (!_statisticsTemplate.statisticsTemplate.index_patterns.includes(pattern)) {
      _statisticsTemplate.statisticsTemplate.index_patterns.push(pattern);
    }

    ; // Update the statistics template

    await context.core.opensearch.client.asInternalUser.indices.putTemplate({
      name: _constants.WAZUH_STATISTICS_TEMPLATE_NAME,
      body: _statisticsTemplate.statisticsTemplate
    });
    (0, _logger.log)('scheduler-handler:checkTemplate', 'Updated the statistics template', 'debug');
  } catch (error) {
    const errorMessage = `Something went wrong updating the statistics template ${error.message || error}`;
    (0, _logger.log)('scheduler-handler:checkTemplate', errorMessage);
    context.wazuh.logger.error(schedulerErrorLogColors, errorMessage);
    throw error;
  }
};

async function jobSchedulerRun(context) {
  // Check Kibana index and if it is prepared, start the initialization of Wazuh App.
  await checkPluginPlatformStatus(context);

  for (const job in (0, _configuredJobs.configuredJobs)({})) {
    const schedulerJob = new _index.SchedulerJob(job, context);
    schedulerJobs.push(schedulerJob);

    const task = _nodeCron.default.schedule(_index.jobs[job].interval, () => schedulerJob.run());
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjaGVkdWxlci1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbImJsdWVXYXp1aCIsInNjaGVkdWxlckVycm9yTG9nQ29sb3JzIiwic2NoZWR1bGVySm9icyIsImNoZWNrUGx1Z2luUGxhdGZvcm1TdGF0dXMiLCJjb250ZXh0IiwiY2hlY2tFbGFzdGljc2VhcmNoU2VydmVyIiwiY2hlY2tUZW1wbGF0ZSIsImVycm9yIiwibWVzYWdlIiwiZGF0YSIsImNvcmUiLCJvcGVuc2VhcmNoIiwiY2xpZW50IiwiYXNJbnRlcm5hbFVzZXIiLCJpbmRpY2VzIiwiZXhpc3RzIiwiaW5kZXgiLCJzZXJ2ZXIiLCJjb25maWciLCJvcGVuc2VhcmNoRGFzaGJvYXJkcyIsImJvZHkiLCJtZXNzYWdlIiwiUHJvbWlzZSIsInJlamVjdCIsImFwcENvbmZpZyIsInByZWZpeFRlbXBsYXRlTmFtZSIsInN0YXRpc3RpY3NJbmRpY2VzVGVtcGxhdGVOYW1lIiwicGF0dGVybiIsImN1cnJlbnRUZW1wbGF0ZSIsImdldFRlbXBsYXRlIiwibmFtZSIsIldBWlVIX1NUQVRJU1RJQ1NfVEVNUExBVEVfTkFNRSIsInN0YXRpc3RpY3NUZW1wbGF0ZSIsImluZGV4X3BhdHRlcm5zIiwiaW5jbHVkZXMiLCJwdXNoIiwicHV0VGVtcGxhdGUiLCJlcnJvck1lc3NhZ2UiLCJ3YXp1aCIsImxvZ2dlciIsImpvYlNjaGVkdWxlclJ1biIsImpvYiIsInNjaGVkdWxlckpvYiIsIlNjaGVkdWxlckpvYiIsInRhc2siLCJjcm9uIiwic2NoZWR1bGUiLCJqb2JzIiwiaW50ZXJ2YWwiLCJydW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLFNBQVMsR0FBRywyQkFBbEI7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxDQUFDRCxTQUFELEVBQVksV0FBWixFQUF5QixPQUF6QixDQUFoQztBQUNBLE1BQU1FLGFBQWEs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Z0U7QUFFdEVYLE1BQUFBLElBQUksRUFBRVk7QUFGZ0UsS0FBbEUsQ0FBTjtBQUlBLHFCQUNFLGlDQURGLEVBRUUsaUNBRkYsRUFHRSxPQUhGO0FBS0QsR0F2Q0QsQ0F1Q0UsT0FBT3pCLEtBQVAsRUFBYztBQUNkLFVBQU04QixZQUFZLEdBQUkseURBQXdEOUIsS0FBSyxDQUFDYyxPQUFOLElBQWlCZCxLQUFNLEVBQXJHO0FBQ0EscUJBQ0UsaUNBREYsRUFFRThCLFlBRkY7QUFJQWpDLElBQUFBLE9BQU8sQ0FBQ2tDLEtBQVIsQ0FBY0MsTUFBZCxDQUFxQmhDLEtBQXJCLENBQTJCTix1QkFBM0IsRUFBb0RvQyxZQUFwRDtBQUNBLFVBQU05QixLQUFOO0FBQ0Q7QUFDRixDQWpERDs7QUFtRE8sZUFBZWlDLGVBQWYsQ0FBK0JwQyxPQUEvQixFQUF1QztBQUM1QztBQUNBLFFBQU1ELHlCQUF5QixDQUFDQyxPQUFELENBQS9COztBQUNBLE9BQUssTUFBTXFDLEdBQVgsSUFBa0Isb0NBQWUsRUFBZixDQUFsQixFQUFzQztBQUNwQyxVQUFNQyxZQUEwQixHQUFHLElBQUlDLG1CQUFKLENBQWlCRixHQUFqQixFQUFzQnJDLE9BQXRCLENBQW5DO0FBQ0FGLElBQUFBLGFBQWEsQ0FBQ2lDLElBQWQsQ0FBbUJPLFlBQW5COztBQUNBLFVBQU1FLElBQUksR0FBR0Msa0JBQUtDLFFBQUwsQ0FDWEMsWUFBS04sR0FBTCxFQUFVTyxRQURDLEVBRVgsTUFBTU4sWUFBWSxDQUFDTyxHQUFiLEVBRkssQ0FBYjtBQUlEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqb2JzLCBTY2hlZHVsZXJKb2IgfSBmcm9tICcuL2luZGV4JztcbmltcG9ydCB7IGNvbmZpZ3VyZWRKb2JzIH0gZnJvbSAnLi9jb25maWd1cmVkLWpvYnMnO1xuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vLi4vbGliL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vLi4vbGliL2dldC1jb25maWd1cmF0aW9uJztcbmltcG9ydCBjcm9uIGZyb20gJ25vZGUtY3Jvbic7XG5pbXBvcnQgeyBXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUUgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vY29uc3RhbnRzJztcbmltcG9ydCB7IHN0YXRpc3RpY3NUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2ludGVncmF0aW9uLWZpbGVzL3N0YXRpc3RpY3MtdGVtcGxhdGUnO1xuaW1wb3J0IHsgZGVsYXlBc1Byb21pc2UgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vdXRpbHMnO1xuaW1wb3J0IHsgZ2V0U2V0dGluZ0RlZmF1bHRWYWx1ZSB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9zZXJ2aWNlcy9zZXR0aW5ncyc7XG5cbmNvbnN0IGJsdWVXYXp1aCA9ICdcXHUwMDFiWzM0bXdhenVoXFx1MDAxYlszOW0nO1xuY29uc3Qgc2NoZWR1bGVyRXJyb3JMb2dDb2xvcnMgPSBbYmx1ZVdhenVoLCAnc2NoZWR1bGVyJywgJ2Vycm9yJ107XG5jb25zdCBzY2hlZHVsZXJKb2JzID0gW107XG5cbi8qKlxuKiBXYWl0IHVudGlsIEtpYmFuYSBzZXJ2ZXIgaXMgcmVhZHlcbiovXG5jb25zdCBjaGVja1BsdWdpblBsYXRmb3JtU3RhdHVzID0gYXN5bmMgZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgdHJ5IHtcbiAgICAgbG9nKFxuICAgICAgICdzY2hlZHVsZXItaGFuZGxlcjpjaGVja1BsdWdpblBsYXRmb3JtU3RhdHVzJyxcbiAgICAgICAnV2FpdGluZyBmb3IgS2liYW5hIGFuZCBFbGFzdGljc2VhcmNoIHNlcnZlcnMgdG8gYmUgcmVhZHkuLi4nLFxuICAgICAgICdkZWJ1ZydcbiAgICAgKTtcblxuICAgIGF3YWl0IGNoZWNrRWxhc3RpY3NlYXJjaFNlcnZlcihjb250ZXh0KTtcbiAgICBhd2FpdCBjaGVja1RlbXBsYXRlKGNvbnRleHQpO1xuICAgIHJldHVybjtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgbG9nKFxuICAgICAgICdzY2hlZHVsZXItaGFuZGxlcjpjaGVja1BsdWdpblBsYXRmb3JtU3RhdHVzJyxcbiAgICAgICBlcnJvci5tZXNhZ2UgfHxlcnJvclxuICAgICApO1xuICAgICB0cnl7XG4gICAgICAgYXdhaXQgZGVsYXlBc1Byb21pc2UoMzAwMCk7XG4gICAgICAgYXdhaXQgY2hlY2tQbHVnaW5QbGF0Zm9ybVN0YXR1cyhjb250ZXh0KTtcbiAgICAgfWNhdGNoKGVycm9yKXt9O1xuICB9XG4gfVxuXG5cbiAvKipcbiAgKiBDaGVjayBFbGFzdGljc2VhcmNoIFNlcnZlciBzdGF0dXMgYW5kIEtpYmFuYSBpbmRleCBwcmVzZW5jZVxuICAqL1xuIGNvbnN0IGNoZWNrRWxhc3RpY3NlYXJjaFNlcnZlciA9IGFzeW5jIGZ1bmN0aW9uIChjb250ZXh0KSB7XG4gICB0cnkge1xuICAgICBjb25zdCBkYXRhID0gYXdhaXQgY29udGV4dC5jb3JlLm9wZW5zZWFyY2guY2xpZW50LmFzSW50ZXJuYWxVc2VyLmluZGljZXMuZXhpc3RzKHtcbiAgICAgICBpbmRleDogY29udGV4dC5zZXJ2ZXIuY29uZmlnLm9wZW5zZWFyY2hEYXNoYm9hcmRzLmluZGV4XG4gICAgIH0pO1xuXG4gICAgIHJldHVybiBkYXRhLmJvZHk7XG4gICB9IGNhdGNoIChlcnJvcikge1xuICAgICBsb2coJ3NjaGVkdWxlci1oYW5kbGVyOmNoZWNrRWxhc3RpY3NlYXJjaFNlcnZlcicsIGVycm9yLm1lc3NhZ2UgfHwgZXJyb3IpO1xuICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgfVxuIH1cblxuXG4gLyoqXG4gKiBWZXJpZnkgd2F6dWgtc3RhdGlzdGljcyB0ZW1wbGF0ZVxuICovXG5jb25zdCBjaGVja1RlbXBsYXRlID0gYXN5bmMgZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgdHJ5IHtcbiAgICBsb2coXG4gICAgICAnc2NoZWR1bGVyLWhhbmRsZXI6Y2hlY2tUZW1wbGF0ZScsXG4gICAgICAnVXBkYXRpbmcgdGhlIHN0YXRpc3RpY3MgdGVtcGxhdGUnLFxuICAgICAgJ2RlYnVnJ1xuICAgICk7XG5cbiAgICBjb25zdCBhcHBDb25maWcgPSBhd2FpdCBnZXRDb25maWd1cmF0aW9uKCk7XG4gICAgY29uc3QgcHJlZml4VGVtcGxhdGVOYW1lID0gYXBwQ29uZmlnWydjcm9uLnByZWZpeCddIHx8IGdldFNldHRpbmdEZWZhdWx0VmFsdWUoJ2Nyb24ucHJlZml4Jyk7XG4gICAgY29uc3Qgc3RhdGlzdGljc0luZGljZXNUZW1wbGF0ZU5hbWUgPSBhcHBDb25maWdbJ2Nyb24uc3RhdGlzdGljcy5pbmRleC5uYW1lJ10gfHwgZ2V0U2V0dGluZ0RlZmF1bHRWYWx1ZSgnY3Jvbi5zdGF0aXN0aWNzLmluZGV4Lm5hbWUnKTtcbiAgICBjb25zdCBwYXR0ZXJuID0gYCR7cHJlZml4VGVtcGxhdGVOYW1lfS0ke3N0YXRpc3RpY3NJbmRpY2VzVGVtcGxhdGVOYW1lfS0qYDtcblxuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBpZiB0aGUgdGVtcGxhdGUgYWxyZWFkeSBleGlzdHNcbiAgICAgIGNvbnN0IGN1cnJlbnRUZW1wbGF0ZSA9IGF3YWl0IGNvbnRleHQuY29yZS5vcGVuc2VhcmNoLmNsaWVudC5hc0ludGVybmFsVXNlci5pbmRpY2VzLmdldFRlbXBsYXRlKHtcbiAgICAgICAgbmFtZTogV0FaVUhfU1RBVElTVElDU19URU1QTEFURV9OQU1FXG4gICAgICB9KTtcbiAgICAgIC8vIENvcHkgYWxyZWFkeSBjcmVhdGVkIGluZGV4IHBhdHRlcm5zXG4gICAgICBzdGF0aXN0aWNzVGVtcGxhdGUuaW5kZXhfcGF0dGVybnMgPSBjdXJyZW50VGVtcGxhdGUuYm9keVtXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUVdLmluZGV4X3BhdHRlcm5zO1xuICAgIH1jYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIEluaXQgd2l0aCB0aGUgZGVmYXVsdCBpbmRleCBwYXR0ZXJuXG4gICAgICBzdGF0aXN0aWNzVGVtcGxhdGUuaW5kZXhfcGF0dGVybnMgPSBbcGF0dGVybl07XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdGhlIHVzZXIgaXMgdXNpbmcgYSBjdXN0b20gcGF0dGVybiBhbmQgYWRkIGl0IHRvIHRoZSB0ZW1wbGF0ZSBpZiBpdCBkb2VzXG4gICAgaWYgKCFzdGF0aXN0aWNzVGVtcGxhdGUuaW5kZXhfcGF0dGVybnMuaW5jbHVkZXMocGF0dGVybikpIHtcbiAgICAgIHN0YXRpc3RpY3NUZW1wbGF0ZS5pbmRleF9wYXR0ZXJucy5wdXNoKHBhdHRlcm4pO1xuICAgIH07XG5cbiAgICAvLyBVcGRhdGUgdGhlIHN0YXRpc3RpY3MgdGVtcGxhdGVcbiAgICBhd2FpdCBjb250ZXh0LmNvcmUub3BlbnNlYXJjaC5jbGllbnQuYXNJbnRlcm5hbFVzZXIuaW5kaWNlcy5wdXRUZW1wbGF0ZSh7XG4gICAgICBuYW1lOiBXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUUsXG4gICAgICBib2R5OiBzdGF0aXN0aWNzVGVtcGxhdGVcbiAgICB9KTtcbiAgICBsb2coXG4gICAgICAnc2NoZWR1bGVyLWhhbmRsZXI6Y2hlY2tUZW1wbGF0ZScsXG4gICAgICAnVXBkYXRlZCB0aGUgc3RhdGlzdGljcyB0ZW1wbGF0ZScsXG4gICAgICAnZGVidWcnXG4gICAgKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgU29tZXRoaW5nIHdlbnQgd3JvbmcgdXBkYXRpbmcgdGhlIHN0YXRpc3RpY3MgdGVtcGxhdGUgJHtlcnJvci5tZXNzYWdlIHx8IGVycm9yfWA7XG4gICAgbG9nKFxuICAgICAgJ3NjaGVkdWxlci1oYW5kbGVyOmNoZWNrVGVtcGxhdGUnLFxuICAgICAgZXJyb3JNZXNzYWdlXG4gICAgKTtcbiAgICBjb250ZXh0LndhenVoLmxvZ2dlci5lcnJvcihzY2hlZHVsZXJFcnJvckxvZ0NvbG9ycywgZXJyb3JNZXNzYWdlKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gam9iU2NoZWR1bGVyUnVuKGNvbnRleHQpe1xuICAvLyBDaGVjayBLaWJhbmEgaW5kZXggYW5kIGlmIGl0IGlzIHByZXBhcmVkLCBzdGFydCB0aGUgaW5pdGlhbGl6YXRpb24gb2YgV2F6dWggQXBwLlxuICBhd2FpdCBjaGVja1BsdWdpblBsYXRmb3JtU3RhdHVzKGNvbnRleHQpO1xuICBmb3IgKGNvbnN0IGpvYiBpbiBjb25maWd1cmVkSm9icyh7fSkpIHtcbiAgICBjb25zdCBzY2hlZHVsZXJKb2I6IFNjaGVkdWxlckpvYiA9IG5ldyBTY2hlZHVsZXJKb2Ioam9iLCBjb250ZXh0KTtcbiAgICBzY2hlZHVsZXJKb2JzLnB1c2goc2NoZWR1bGVySm9iKTtcbiAgICBjb25zdCB0YXNrID0gY3Jvbi5zY2hlZHVsZShcbiAgICAgIGpvYnNbam9iXS5pbnRlcnZhbCxcbiAgICAgICgpID0+IHNjaGVkdWxlckpvYi5ydW4oKSxcbiAgICApO1xuICB9XG59XG4iXX0=