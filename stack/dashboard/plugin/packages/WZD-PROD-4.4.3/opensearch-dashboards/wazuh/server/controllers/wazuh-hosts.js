"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WazuhHostsCtrl = void 0;

var _constants = require("../../common/constants");

var _cacheApiUserHasRunAs = require("../lib/cache-api-user-has-run-as");

var _errorResponse = require("../lib/error-response");

var _logger = require("../lib/logger");

var _manageHosts = require("../lib/manage-hosts");

var _updateRegistry = require("../lib/update-registry");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class WazuhHostsCtrl {
  constructor() {
    _defineProperty(this, "manageHosts", void 0);

    _defineProperty(this, "updateRegistry", void 0);

    this.manageHosts = new _manageHosts.ManageHosts();
    this.updateRegistry = new _updateRegistry.UpdateRegistry();
  }
  /**
   * This get all hosts entries in the wazuh.yml and the related info in the wazuh-registry.json
   * @param {Object} context
   * @param {Object} request
   * @param {Object} response
   * API entries or ErrorResponse
   */


  async getHostsEntries(context, request, response) {
    try {
      const removePassword = true;
      const hosts = await this.manageHosts.getHosts();
      const registry = await this.updateRegistry.getHosts();
      const result = await this.joinHostRegistry(hosts, registry, removePassword);
      return response.ok({
        body: result
      });
    } catch (error) {
      if (error && error.message && ['ENOENT: no such file or directory', _constants.WAZUH_DATA_PLUGIN_PLATFORM_BASE_ABSOLUTE_PATH].every(text => error.message.includes(text))) {
        return response.badRequest({
          body: {
            message: `Error getting the hosts entries: The \'${_constants.WAZUH_DATA_PLUGIN_PLATFORM_BASE_ABSOLUTE_PATH}\' directory could not exist in your ${_constants.PLUGIN_PLATFORM_NAME} installation.
            If this doesn't exist, create it and give the permissions 'sudo mkdir ${_constants.WAZUH_DATA_PLUGIN_PLATFORM_BASE_ABSOLUTE_PATH};sudo chown -R ${_constants.PLUGIN_PLATFORM_INSTALLATION_USER}:${_constants.PLUGIN_PLATFORM_INSTALLATION_USER_GROUP} ${_constants.WAZUH_DATA_PLUGIN_PLATFORM_BASE_ABSOLUTE_PATH}'. After, restart the ${_constants.PLUGIN_PLATFORM_NAME} service.`
          }
        });
      }

      (0, _logger.log)('wazuh-hosts:getHostsEntries', error.message || error);
      return (0, _errorResponse.ErrorResponse)(error.message || error, 2001, 500, response);
    }
  }
  /**
   * Joins the hosts with the related information in the registry
   * @param {Object} hosts
   * @param {Object} registry
   * @param {Boolean} removePassword
   */


  async joinHostRegistry(hosts, registry, removePassword = true) {
    try {
      if (!Array.isArray(hosts)) {
        throw new Error('Hosts configuration error in wazuh.yml');
      }

      return await Promise.all(hosts.map(async h => {
        const id = Object.keys(h)[0];
        const api = Object.assign(h[id], {
          id: id
        });
        const host = Object.assign(api, registry[id]); // Add to run_as from API user. Use the cached value or get it doing a request

        host.allow_run_as = await _cacheApiUserHasRunAs.APIUserAllowRunAs.check(id);

        if (removePassword) {
          delete host.password;
          delete host.token;
        }

        ;
        return host;
      }));
    } catch (error) {
      throw new Error(error);
    }
  }
  /**
   * This update an API hostname
   * @param {Object} context
   * @param {Object} request
   * @param {Object} response
   * Status response or ErrorResponse
   */


  async updateClusterInfo(context, request, response) {
    try {
      const {
        id
      } = request.params;
      const {
        cluster_info
      } = request.body;
      await this.updateRegistry.updateClusterInfo(id, cluster_info);
      (0, _logger.log)('wazuh-hosts:updateClusterInfo', `API entry ${id} hostname updated`, 'debug');
      return response.ok({
        body: {
          statusCode: 200,
          message: 'ok'
        }
      });
    } catch (error) {
      (0, _logger.log)('wazuh-hosts:updateClusterInfo', error.message || error);
      return (0, _errorResponse.ErrorResponse)(`Could not update data in wazuh-registry.json due to ${error.message || error}`, 2012, 500, response);
    }
  }
  /**
   * Remove the orphan host entries in the registry
   * @param {Object} context
   * @param {Object} request
   * @param {Object} response
   */


  async removeOrphanEntries(context, request, response) {
    try {
      const {
        entries
      } = request.body;
      (0, _logger.log)('wazuh-hosts:cleanRegistry', 'Cleaning registry', 'debug');
      await this.updateRegistry.removeOrphanEntries(entries);
      return response.ok({
        body: {
          statusCode: 200,
          message: 'ok'
        }
      });
    } catch (error) {
      (0, _logger.log)('wazuh-hosts:cleanRegistry', error.message || error);
      return (0, _errorResponse.ErrorResponse)(`Could not clean entries in the wazuh-registry.json due to ${error.message || error}`, 2013, 500, response);
    }
  }

}

exports.WazuhHostsCtrl = WazuhHostsCtrl;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndhenVoLWhvc3RzLnRzIl0sIm5hbWVzIjpbIldhenVoSG9zdHNDdHJsIiwiY29uc3RydWN0b3IiLCJtYW5hZ2VIb3N0cyIsIk1hbmFnZUhvc3RzIiwidXBkYXRlUmVnaXN0cnkiLCJVcGRhdGVSZWdpc3RyeSIsImdldEhvc3RzRW50cmllcyIsImNvbnRleHQiLCJyZXF1ZXN0IiwicmVzcG9uc2UiLCJyZW1vdmVQYXNzd29yZCIsImhvc3RzIiwiZ2V0SG9zdHMiLCJyZWdpc3RyeSIsInJlc3VsdCIsImpvaW5Ib3N0UmVnaXN0cnkiLCJvayIsImJvZHkiLCJlcnJvciIsIm1lc3NhZ2UiLCJXQVpVSF9EQVRBX1BMVUdJTl9QTEFURk9STV9CQVNFX0FCU09MVVRFX1BBVEgiLCJldmVyeSIsInRleHQiLCJpbmNsdWRlcyIsImJhZFJlcXVlc3QiLCJQTFVHSU5fUExBVEZPUk1fTkFNRSIsIlBMVUdJTl9QTEFURk9STV9JTlNUQUxMQVRJT05fVVNFUiIsIlBMVUdJTl9QTEFURk9STV9JTlNUQUxMQVRJT05fVVNFUl9HUk9VUCIsIkFycmF5IiwiaXNBcnJheSIsIkVycm9yIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsImgiLCJpZCIsIk9iamVjdCIsImtleXMiLCJhcGkiLCJhc3NpZ24iLCJob3N0IiwiYWxsb3dfcnVuX2FzIiwiQVBJVXNlckFsbG93UnVuQXMiLCJjaGVjayIsInBhc3N3b3JkIiwidG9rZW4iLCJ1cGRhdGVDbHVzdGVySW5mbyIsInBhcmFtcyIsImNsdXN0ZXJfaW5mbyIsInN0YXR1c0NvZGUiLCJyZW1vdmVPcnBoYW5FbnRyaWVzIiwiZW50cmllcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWlCQTs7QUFNQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVPLE1BQU1BLGNBQU4sQ0FBcUI7QUFHMUJDLEVBQUFBLFdBQVcsR0FBRztBQUFBOztBQUFBOztBQUNaLFNBQUtDLFdBQUwsR0FBbUIsSUFBSUMsd0JBQUosRUFBbkI7QUFDQSxTQUFLQyxj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QU0sS0FBS2IsY0FBTCxDQUFvQjhDLG1CQUFwQixDQUF3Q0MsT0FBeEMsQ0FBTjtBQUNBLGFBQU8xQyxRQUFRLENBQUNPLEVBQVQsQ0FBWTtBQUNqQkMsUUFBQUEsSUFBSSxFQUFFO0FBQUVnQyxVQUFBQSxVQUFVLEVBQUUsR0FBZDtBQUFtQjlCLFVBQUFBLE9BQU8sRUFBRTtBQUE1QjtBQURXLE9BQVosQ0FBUDtBQUdELEtBUEQsQ0FPRSxPQUFPRCxLQUFQLEVBQWM7QUFDZCx1QkFBSSwyQkFBSixFQUFpQ0EsS0FBSyxDQUFDQyxPQUFOLElBQWlCRCxLQUFsRDtBQUNBLGFBQU8sa0NBQ0osNkRBQTREQSxLQUFLLENBQUNDLE9BQU4sSUFBaUJELEtBQU0sRUFEL0UsRUFFTCxJQUZLLEVBR0wsR0FISyxFQUlMVCxRQUpLLENBQVA7QUFNRDtBQUNGOztBQXhIeUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogV2F6dWggYXBwIC0gQ2xhc3MgZm9yIFdhenVoLUFQSSBmdW5jdGlvbnNcbiAqIENvcHlyaWdodCAoQykgMjAxNS0yMDIyIFdhenVoLCBJbmMuXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAyIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBGaW5kIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgdGhpcyBvbiB0aGUgTElDRU5TRSBmaWxlLlxuICovXG5cbmltcG9ydCB7XG4gIE9wZW5TZWFyY2hEYXNoYm9hcmRzUmVxdWVzdCxcbiAgUmVxdWVzdEhhbmRsZXJDb250ZXh0LFxuICBPcGVuU2VhcmNoRGFzaGJvYXJkc1Jlc3BvbnNlRmFjdG9yeSxcbn0gZnJvbSAnc3JjL2NvcmUvc2VydmVyJztcbmltcG9ydCB7XG4gIFBMVUdJTl9QTEFURk9STV9JTlNUQUxMQVRJT05fVVNFUixcbiAgUExVR0lOX1BMQVRGT1JNX0lOU1RBTExBVElPTl9VU0VSX0dST1VQLFxuICBQTFVHSU5fUExBVEZPUk1fTkFNRSxcbiAgV0FaVUhfREFUQV9QTFVHSU5fUExBVEZPUk1fQkFTRV9BQlNPTFVURV9QQVRILFxufSBmcm9tICcuLi8uLi9jb21tb24vY29uc3RhbnRzJztcbmltcG9ydCB7IEFQSVVzZXJBbGxvd1J1bkFzIH0gZnJvbSAnLi4vbGliL2NhY2hlLWFwaS11c2VyLWhhcy1ydW4tYXMnO1xuaW1wb3J0IHsgRXJyb3JSZXNwb25zZSB9IGZyb20gJy4uL2xpYi9lcnJvci1yZXNwb25zZSc7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi9saWIvbG9nZ2VyJztcbmltcG9ydCB7IE1hbmFnZUhvc3RzIH0gZnJvbSAnLi4vbGliL21hbmFnZS1ob3N0cyc7XG5pbXBvcnQgeyBVcGRhdGVSZWdpc3RyeSB9IGZyb20gJy4uL2xpYi91cGRhdGUtcmVnaXN0cnknO1xuXG5leHBvcnQgY2xhc3MgV2F6dWhIb3N0c0N0cmwge1xuICBtYW5hZ2VIb3N0czogTWFuYWdlSG9zdHM7XG4gIHVwZGF0ZVJlZ2lzdHJ5OiBVcGRhdGVSZWdpc3RyeTtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5tYW5hZ2VIb3N0cyA9IG5ldyBNYW5hZ2VIb3N0cygpO1xuICAgIHRoaXMudXBkYXRlUmVnaXN0cnkgPSBuZXcgVXBkYXRlUmVnaXN0cnkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGdldCBhbGwgaG9zdHMgZW50cmllcyBpbiB0aGUgd2F6dWgueW1sIGFuZCB0aGUgcmVsYXRlZCBpbmZvIGluIHRoZSB3YXp1aC1yZWdpc3RyeS5qc29uXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZVxuICAgKiBBUEkgZW50cmllcyBvciBFcnJvclJlc3BvbnNlXG4gICAqL1xuICBhc3luYyBnZXRIb3N0c0VudHJpZXMoY29udGV4dDogUmVxdWVzdEhhbmRsZXJDb250ZXh0LCByZXF1ZXN0OiBPcGVuU2VhcmNoRGFzaGJvYXJkc1JlcXVlc3QsIHJlc3BvbnNlOiBPcGVuU2VhcmNoRGFzaGJvYXJkc1Jlc3BvbnNlRmFjdG9yeSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZW1vdmVQYXNzd29yZCA9IHRydWU7XG4gICAgICBjb25zdCBob3N0cyA9IGF3YWl0IHRoaXMubWFuYWdlSG9zdHMuZ2V0SG9zdHMoKTtcbiAgICAgIGNvbnN0IHJlZ2lzdHJ5ID0gYXdhaXQgdGhpcy51cGRhdGVSZWdpc3RyeS5nZXRIb3N0cygpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5qb2luSG9zdFJlZ2lzdHJ5KGhvc3RzLCByZWdpc3RyeSwgcmVtb3ZlUGFzc3dvcmQpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHtcbiAgICAgICAgYm9keTogcmVzdWx0XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYoZXJyb3IgJiYgZXJyb3IubWVzc2FnZSAmJiBbJ0VOT0VOVDogbm8gc3VjaCBmaWxlIG9yIGRpcmVjdG9yeScsIFdBWlVIX0RBVEFfUExVR0lOX1BMQVRGT1JNX0JBU0VfQUJTT0xVVEVfUEFUSF0uZXZlcnkodGV4dCA9PiBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKHRleHQpKSl7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KHtcbiAgICAgICAgICBib2R5OiB7XG4gICAgICAgICAgICBtZXNzYWdlOiBgRXJyb3IgZ2V0dGluZyB0aGUgaG9zdHMgZW50cmllczogVGhlIFxcJyR7V0FaVUhfREFUQV9QTFVHSU5fUExBVEZPUk1fQkFTRV9BQlNPTFVURV9QQVRIfVxcJyBkaXJlY3RvcnkgY291bGQgbm90IGV4aXN0IGluIHlvdXIgJHtQTFVHSU5fUExBVEZPUk1fTkFNRX0gaW5zdGFsbGF0aW9uLlxuICAgICAgICAgICAgSWYgdGhpcyBkb2Vzbid0IGV4aXN0LCBjcmVhdGUgaXQgYW5kIGdpdmUgdGhlIHBlcm1pc3Npb25zICdzdWRvIG1rZGlyICR7V0FaVUhfREFUQV9QTFVHSU5fUExBVEZPUk1fQkFTRV9BQlNPTFVURV9QQVRIfTtzdWRvIGNob3duIC1SICR7UExVR0lOX1BMQVRGT1JNX0lOU1RBTExBVElPTl9VU0VSfToke1BMVUdJTl9QTEFURk9STV9JTlNUQUxMQVRJT05fVVNFUl9HUk9VUH0gJHtXQVpVSF9EQVRBX1BMVUdJTl9QTEFURk9STV9CQVNFX0FCU09MVVRFX1BBVEh9Jy4gQWZ0ZXIsIHJlc3RhcnQgdGhlICR7UExVR0lOX1BMQVRGT1JNX05BTUV9IHNlcnZpY2UuYFxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIGxvZygnd2F6dWgtaG9zdHM6Z2V0SG9zdHNFbnRyaWVzJywgZXJyb3IubWVzc2FnZSB8fCBlcnJvcik7XG4gICAgICByZXR1cm4gRXJyb3JSZXNwb25zZShlcnJvci5tZXNzYWdlIHx8IGVycm9yLCAyMDAxLCA1MDAsIHJlc3BvbnNlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSm9pbnMgdGhlIGhvc3RzIHdpdGggdGhlIHJlbGF0ZWQgaW5mb3JtYXRpb24gaW4gdGhlIHJlZ2lzdHJ5XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBob3N0c1xuICAgKiBAcGFyYW0ge09iamVjdH0gcmVnaXN0cnlcbiAgICogQHBhcmFtIHtCb29sZWFufSByZW1vdmVQYXNzd29yZFxuICAgKi9cbiAgYXN5bmMgam9pbkhvc3RSZWdpc3RyeShob3N0czogYW55LCByZWdpc3RyeTogYW55LCByZW1vdmVQYXNzd29yZDogYm9vbGVhbiA9IHRydWUpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGhvc3RzKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hvc3RzIGNvbmZpZ3VyYXRpb24gZXJyb3IgaW4gd2F6dWgueW1sJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChob3N0cy5tYXAoYXN5bmMgaCA9PiB7XG4gICAgICAgIGNvbnN0IGlkID0gT2JqZWN0LmtleXMoaClbMF07XG4gICAgICAgIGNvbnN0IGFwaSA9IE9iamVjdC5hc3NpZ24oaFtpZF0sIHsgaWQ6IGlkIH0pO1xuICAgICAgICBjb25zdCBob3N0ID0gT2JqZWN0LmFzc2lnbihhcGksIHJlZ2lzdHJ5W2lkXSk7XG4gICAgICAgIC8vIEFkZCB0byBydW5fYXMgZnJvbSBBUEkgdXNlci4gVXNlIHRoZSBjYWNoZWQgdmFsdWUgb3IgZ2V0IGl0IGRvaW5nIGEgcmVxdWVzdFxuICAgICAgICBob3N0LmFsbG93X3J1bl9hcyA9IGF3YWl0IEFQSVVzZXJBbGxvd1J1bkFzLmNoZWNrKGlkKTtcbiAgICAgICAgaWYgKHJlbW92ZVBhc3N3b3JkKSB7XG4gICAgICAgICAgZGVsZXRlIGhvc3QucGFzc3dvcmQ7XG4gICAgICAgICAgZGVsZXRlIGhvc3QudG9rZW47XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBob3N0O1xuICAgICAgfSkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICogVGhpcyB1cGRhdGUgYW4gQVBJIGhvc3RuYW1lXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZVxuICAgKiBTdGF0dXMgcmVzcG9uc2Ugb3IgRXJyb3JSZXNwb25zZVxuICAgKi9cbiAgYXN5bmMgdXBkYXRlQ2x1c3RlckluZm8oY29udGV4dDogUmVxdWVzdEhhbmRsZXJDb250ZXh0LCByZXF1ZXN0OiBPcGVuU2VhcmNoRGFzaGJvYXJkc1JlcXVlc3QsIHJlc3BvbnNlOiBPcGVuU2VhcmNoRGFzaGJvYXJkc1Jlc3BvbnNlRmFjdG9yeSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGlkIH0gPSByZXF1ZXN0LnBhcmFtcztcbiAgICAgIGNvbnN0IHsgY2x1c3Rlcl9pbmZvIH0gPSByZXF1ZXN0LmJvZHk7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZVJlZ2lzdHJ5LnVwZGF0ZUNsdXN0ZXJJbmZvKGlkLCBjbHVzdGVyX2luZm8pO1xuICAgICAgbG9nKFxuICAgICAgICAnd2F6dWgtaG9zdHM6dXBkYXRlQ2x1c3RlckluZm8nLFxuICAgICAgICBgQVBJIGVudHJ5ICR7aWR9IGhvc3RuYW1lIHVwZGF0ZWRgLFxuICAgICAgICAnZGVidWcnXG4gICAgICApO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHtcbiAgICAgICAgYm9keTogeyBzdGF0dXNDb2RlOiAyMDAsIG1lc3NhZ2U6ICdvaycgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZygnd2F6dWgtaG9zdHM6dXBkYXRlQ2x1c3RlckluZm8nLCBlcnJvci5tZXNzYWdlIHx8IGVycm9yKTtcbiAgICAgIHJldHVybiBFcnJvclJlc3BvbnNlKFxuICAgICAgICBgQ291bGQgbm90IHVwZGF0ZSBkYXRhIGluIHdhenVoLXJlZ2lzdHJ5Lmpzb24gZHVlIHRvICR7ZXJyb3IubWVzc2FnZSB8fCBlcnJvcn1gLFxuICAgICAgICAyMDEyLFxuICAgICAgICA1MDAsXG4gICAgICAgIHJlc3BvbnNlXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgdGhlIG9ycGhhbiBob3N0IGVudHJpZXMgaW4gdGhlIHJlZ2lzdHJ5XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZVxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlT3JwaGFuRW50cmllcyhjb250ZXh0OiBSZXF1ZXN0SGFuZGxlckNvbnRleHQsIHJlcXVlc3Q6IE9wZW5TZWFyY2hEYXNoYm9hcmRzUmVxdWVzdCwgcmVzcG9uc2U6IE9wZW5TZWFyY2hEYXNoYm9hcmRzUmVzcG9uc2VGYWN0b3J5KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZW50cmllcyB9ID0gcmVxdWVzdC5ib2R5O1xuICAgICAgbG9nKCd3YXp1aC1ob3N0czpjbGVhblJlZ2lzdHJ5JywgJ0NsZWFuaW5nIHJlZ2lzdHJ5JywgJ2RlYnVnJyk7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZVJlZ2lzdHJ5LnJlbW92ZU9ycGhhbkVudHJpZXMoZW50cmllcyk7XG4gICAgICByZXR1cm4gcmVzcG9uc2Uub2soe1xuICAgICAgICBib2R5OiB7IHN0YXR1c0NvZGU6IDIwMCwgbWVzc2FnZTogJ29rJyB9XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nKCd3YXp1aC1ob3N0czpjbGVhblJlZ2lzdHJ5JywgZXJyb3IubWVzc2FnZSB8fCBlcnJvcik7XG4gICAgICByZXR1cm4gRXJyb3JSZXNwb25zZShcbiAgICAgICAgYENvdWxkIG5vdCBjbGVhbiBlbnRyaWVzIGluIHRoZSB3YXp1aC1yZWdpc3RyeS5qc29uIGR1ZSB0byAke2Vycm9yLm1lc3NhZ2UgfHwgZXJyb3J9YCxcbiAgICAgICAgMjAxMyxcbiAgICAgICAgNTAwLFxuICAgICAgICByZXNwb25zZVxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==